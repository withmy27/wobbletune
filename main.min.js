const startButton=document.getElementById("startButton"),canvas=document.getElementById("showWave"),canvasContext=canvas.getContext("2d"),freqView=document.getElementById("showFreq"),noteView=document.getElementById("showNote"),decibelView=document.getElementById("showDecibel");let audioContext;const urlParams=new URL(location.href).searchParams,fftSize=parseInt(Math.pow(2,parseInt(urlParams.get("fftSize")??"12"))),showWave=parseInt(urlParams.get("showWave")??"1");showWave||(canvas.style="display: none"),console.log(fftSize,showWave),startButton.addEventListener("click",async()=>{if(audioContext)return;audioContext=new window.AudioContext;let t=await navigator.mediaDevices.getUserMedia({audio:!0}).catch(t=>{console.error("Error accessing audio stream:",t)}),e=audioContext.createMediaStreamSource(t),a=audioContext.createAnalyser();a.fftSize=fftSize;let o=a.frequencyBinCount,s=new Uint8Array(o),c=new Uint8Array(a.fftSize);e.connect(a);let r,i,l,u;function v(){a.getByteTimeDomainData(c),canvasContext.clearRect(0,0,canvas.width,canvas.height),canvasContext.lineWidth=1,canvasContext.strokeStyle="#646262",canvasContext.beginPath(),canvasContext.moveTo(0,canvas.height/2),canvasContext.lineTo(canvas.width,canvas.height/2),canvasContext.stroke(),canvasContext.strokeStyle="#1e1b1b",canvasContext.beginPath(),u=canvas.width/o,r=canvas.width;for(let t=0;t<o;t++)i=(l=c[t]/128)*canvas.height/2,0===t?canvasContext.moveTo(r,i):canvasContext.lineTo(r,i),r-=u;canvasContext.lineTo(0,canvas.height/2),canvasContext.stroke()}let d,h,f,C;function g(){for(a.getByteFrequencyData(s),d=0,h=0;h<o;h++)s[h]>s[d]&&(d=h);C=d*(f=audioContext.sampleRate/2)/o,freqView.textContent=C+" Hz";let t=pitch(C);t&&(noteView.innerHTML=`${t.note}<sup>${t.octave}</sup>`)}let w=showWave?()=>{v(),g()}:g;setInterval(w,100)});const c0=16.3515978313,log2_c0=Math.log2(16.3515978313),a4=440,pitchRatio=1.05946309436,notes=["C","C♯","D","E♭","E","F","F♯","G","A♭","A","B♭","B"];let k,n,note,octave,accuracy;function pitch(t){return t<=0?null:(note=notes[(n=Math.round(k=(Math.log2(t)-log2_c0)*12))%12],octave=Math.floor(n/12),accuracy=k/n,{note,octave,freq:t,accuracy})}startButton.addEventListener("mousedown",()=>{audioContext||(startButton.style.transform="scale(0.95)")}),startButton.addEventListener("mouseleave",()=>{audioContext||(startButton.style.transform="scale(1.0)")}),startButton.addEventListener("click",()=>{startButton.style.transform="scale(1.0)",startButton.style.color="#1e1b1b",startButton.style.backgroundColor="#f0f0f0"});